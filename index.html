<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>電影推薦應用</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controls { margin-bottom: 20px; }
    #movieInfo { margin-top: 20px; }
    button, select, input { padding: 10px; font-size: 16px; margin-right: 10px; }
    .section { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>電影推薦應用</h1>
  
  <div id="controls">
    <label for="genreSelect">選擇類型:</label>
    <select id="genreSelect">
      <option value="">全部</option>
    </select>
    <label for="searchInput">搜尋電影標題:</label>
    <input type="text" id="searchInput" placeholder="輸入關鍵字">
    <button id="recommendBtn">推薦電影</button>
    <button id="revealBtn" style="display:none;">揭曉電影資訊</button>
  </div>
  
  <div id="movieInfo">正在載入電影資料...</div>

  <script>
    // 請將此處替換成你的 Hugging Face API 金鑰
    const HF_API_KEY = "YOUR_API_KEY";  
    let movies = [];          
    let filteredMovies = [];  
    let currentMovie = null;  

    // 將所有電影的類型加入下拉選單
    function populateGenreOptions() {
      const genreSet = new Set();
      movies.forEach(movie => {
        const genres = movie.info["ジャンル"];
        if (Array.isArray(genres)) {
          genres.forEach(g => genreSet.add(g));
        }
      });
      const genreSelect = document.getElementById("genreSelect");
      genreSet.forEach(genre => {
        const option = document.createElement("option");
        option.value = genre;
        option.textContent = genre;
        genreSelect.appendChild(option);
      });
    }

    // 根據下拉選單與搜尋框內容過濾電影
    function filterMovies() {
      const selectedGenre = document.getElementById("genreSelect").value;
      const searchKeyword = document.getElementById("searchInput").value.toLowerCase();
      filteredMovies = movies.filter(movie => {
        const titleMatch = movie.title.toLowerCase().includes(searchKeyword);
        let genreMatch = true;
        if (selectedGenre) {
          const genres = movie.info["ジャンル"] || [];
          genreMatch = genres.includes(selectedGenre);
        }
        return titleMatch && genreMatch;
      });
    }

    // 利用 Hugging Face summarization API 生成三行摘要
    function generateThreeLineSummary(movie, callback) {
      const info = movie.info;
      if(info["あらすじ"] && Array.isArray(info["あらすじ"])) {
         // 將あらすじ陣列合併為一個完整文字
         const fullSynopsis = info["あらすじ"].join(" ");
         fetch("https://api-inference.huggingface.co/models/facebook/bart-large-cnn", {
            method: "POST",
            headers: {
              "Authorization": "Bearer " + HF_API_KEY,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              inputs: fullSynopsis,
              parameters: { max_length: 150, min_length: 50, do_sample: false }
            })
         })
         .then(response => response.json())
         .then(data => {
           if(data && data[0] && data[0].summary_text) {
              const summary = data[0].summary_text;
              // 利用日文句點（。）作為分隔符分行
              const lines = summary.split(/(?<=。)/);
              // 取前三行（若不足三行則全部顯示）
              const threeLineSummary = lines.slice(0,3).join("<br>");
              callback(threeLineSummary);
           } else {
              callback("無法生成摘要。");
           }
         })
         .catch(error => {
            console.error("Summarization error:", error);
            callback("摘要生成失敗。");
         });
      } else {
         callback("無法生成摘要。");
      }
    }

    // 顯示由 NLP 模組生成的三行摘要
    function displayThreeLineSummary(movie) {
      document.getElementById("movieInfo").innerHTML = `<h2>正在生成三行摘要...</h2>`;
      generateThreeLineSummary(movie, function(summary) {
        let summaryHTML = `<h2>三行摘要 (猜猜這是什麼電影？)</h2>`;
        summaryHTML += `<div class="section">${summary}</div>`;
        document.getElementById("movieInfo").innerHTML = summaryHTML;
      });
    }

    // 顯示電影完整資訊
    function displayMovie(movie) {
      const info = movie.info;
      let html = `<h2>${movie.title}</h2>`;
      html += `<div class="section"><strong>製作年度:</strong> ${info["製作年度"] || "N/A"}</div>`;
      html += `<div class="section"><strong>監督名:</strong> ${info["監督名"] || "N/A"}</div>`;
      html += `<div class="section"><strong>監督説明:</strong> ${info["監督説明"] || "N/A"}</div>`;
      
      if(info["キャスト名"] && info["キャスト説明"]) {
        html += `<div class="section"><strong>キャスト:</strong><ul>`;
        for(let i = 0; i < info["キャスト名"].length; i++){
          const castName = info["キャスト名"][i];
          const castDesc = info["キャスト説明"][i] || "";
          html += `<li>${castName}: ${castDesc}</li>`;
        }
        html += `</ul></div>`;
      }
      
      if(info["ジャンル"]) {
        html += `<div class="section"><strong>ジャンル:</strong> ${info["ジャンル"].join(", ")}</div>`;
      }
      
      if(info["レビュー"]) {
        html += `<div class="section"><strong>レビュー:</strong><ul>`;
        info["レビュー"].forEach(review => {
          html += `<li>${review}</li>`;
        });
        html += `</ul></div>`;
      }
      
      if(info["あらすじ"]) {
        html += `<div class="section"><strong>あらすじ:</strong>`;
        info["あらすじ"].forEach(line => {
          html += `<p>${line}</p>`;
        });
        html += `</div>`;
      }
      
      document.getElementById("movieInfo").innerHTML = html;
      document.getElementById("revealBtn").style.display = "none";
    }

    // 載入電影 JSON 資料（使用 GitHub raw URL）
    fetch('https://raw.githubusercontent.com/ku-nlp/JMRD/main/data/train.json')
      .then(response => response.json())
      .then(data => {
        const movieMap = {};
        data.forEach(dialogue => {
          const title = dialogue.movie_title;
          if (!movieMap[title]) {
            movieMap[title] = dialogue.knowledge;
          }
        });
        movies = Object.keys(movieMap).map(title => ({
          title: title,
          info: movieMap[title]
        }));
        document.getElementById("movieInfo").innerText = `電影資料載入完成，共有 ${movies.length} 部電影。`;
        populateGenreOptions();
        filterMovies();
      })
      .catch(error => {
        console.error('載入 JSON 發生錯誤：', error);
        document.getElementById("movieInfo").innerText = "載入電影資料失敗。";
      });

    document.getElementById("genreSelect").addEventListener("change", filterMovies);
    document.getElementById("searchInput").addEventListener("input", filterMovies);

    // 推薦電影按鈕：從過濾後隨機挑選一部，生成並顯示三行摘要
    document.getElementById("recommendBtn").addEventListener("click", function() {
      filterMovies();
      if (filteredMovies.length === 0) {
        document.getElementById("movieInfo").innerText = "沒有符合條件的電影。";
        return;
      }
      const randomMovie = filteredMovies[Math.floor(Math.random() * filteredMovies.length)];
      currentMovie = randomMovie;
      displayThreeLineSummary(randomMovie);
      document.getElementById("revealBtn").style.display = "inline-block";
    });

    // 揭曉電影資訊按鈕
    document.getElementById("revealBtn").addEventListener("click", function() {
      if (currentMovie) {
        displayMovie(currentMovie);
      }
    });
  </script>
</body>
</html>
